<h1 id="версионирование-данных">Версионирование данных</h1>

<p>Все записи <a href="../../../Обзор_понятий_компонентов_и_связей/Основные_понятия/Логическая_таблица/Логическая_таблица.md">логической таблицы</a> 
с одинаковым первичным ключом рассматриваются системой как исторические состояния одного и того же объекта. 
Одновременно объект системы может иметь множество архивных состояний, а также не более одного актуального 
и не более одного нового (“горячего”) состояния.</p>

<p>Записи, загружаемые в логическую таблицу в рамках одной <a href="../../../Обзор_понятий_компонентов_и_связей/Основные_понятия/Дельта/Дельта.md">дельты</a>, 
должны иметь уникальный первичный ключ. Для того чтобы система могла корректно определить, что делать 
с загруженными записями, каждая из них должна содержать значение <code class="language-sql highlighter-rouge"><span class="n">sys_op</span></code>. Поле <code class="language-sql highlighter-rouge"><span class="n">sys_op</span></code> является 
служебным и может принимать следующие значения:</p>
<ul>
  <li>0 — нужно добавить новую запись или обновить существующую, если такая будет найдена;</li>
  <li>1 — нужно удалить существующую запись.</li>
</ul>

<p>Если поле <code class="language-sql highlighter-rouge"><span class="n">sys_op</span></code> отсутствует в схеме данных Avro и (или) в загружаемых записях, при попытке выполнить 
запрос <a href="../../../Справочная_информация/Запросы_SQLplus/INSERT_INTO_logical_table/INSERT_INTO_logical_table.md">INSERT INTO logical_table</a> 
система вернет исключение.</p>

<p>Все загружаемые данные сохраняются в виде горячих записей, и затем, при фиксации изменений, система 
обновляет состояние объектов логических таблиц в соответствии с новыми данными. Порядок применения каждой 
из новых записей зависит от наличия/отсутствия актуальной записи с таким же первичным ключом и значения 
<code class="language-sql highlighter-rouge"><span class="n">sys_op</span></code> новой записи:</p>
<ul>
  <li>Если актуальная запись есть и значение <code class="language-sql highlighter-rouge"><span class="n">sys_op</span></code> новой записи равно 0, актуальная запись перемещается 
в архив, а новая запись сохраняется в качестве актуальной.</li>
  <li>Если актуальная запись есть и значение <code class="language-sql highlighter-rouge"><span class="n">sys_op</span></code> новой записи равно 1, актуальная запись перемещается 
в архив. Добавление новой записи не происходит, и среди актуальных записей не остается записей 
с этим первичным ключом.</li>
  <li>Если актуальной записи нет, новая запись сохраняется в качестве актуальной.</li>
</ul>

<p><strong>Примечание:</strong> для удаления записи нужно, чтобы все данные новой записи (кроме значения <code class="language-sql highlighter-rouge"><span class="n">sys_op</span></code>) 
совпадали с данными одной из актуальных записей логической таблицы. Если первичные ключи актуальной и новой записи совпадают, но другие данные этих записей различаются, выдается исключение и запись не удаляется.</p>
